<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Xu√¢n 12A1</title>

  <style>
    /* =========================================================
       ‚úÖ GI·ªÆ NGUY√äN CSS (REGISTER + LOGIN + DASHBOARD) 
       ========================================================= */

    .fx-layer{position:fixed;inset:0;pointer-events:none;overflow:hidden;z-index:50;}
    .fx-branch{position:fixed;top:0;width:260px;height:100vh;pointer-events:none;z-index:40;opacity:.95;filter:drop-shadow(0 12px 18px rgba(0,0,0,.25));}
    .fx-branch.left{left:-30px;transform:rotate(-2deg);}
    .fx-branch.right{right:-30px;transform:scaleX(-1) rotate(-2deg);}
    .fx-branch::before,.fx-branch::after{content:"";position:absolute;left:40px;top:-40px;width:18px;height:120%;border-radius:20px;background:linear-gradient(180deg, rgba(60,22,0,.92), rgba(120,60,0,.85));transform:rotate(12deg);}
    .fx-branch::after{left:70px;width:10px;height:70%;opacity:.85;transform:rotate(26deg);}
    .fx-blossoms{position:absolute;inset:0;}
    .fx-blossoms span{position:absolute;font-size:22px;opacity:.9;filter:drop-shadow(0 6px 8px rgba(0,0,0,.25));}

    .fall-item{position:absolute;top:-60px;left:0;will-change:transform;user-select:none;pointer-events:none;opacity:.55;filter:blur(.2px);animation-name:fallDown;animation-timing-function:linear;animation-iteration-count:infinite;}
    .fall-flower{opacity:.65;filter:drop-shadow(0 10px 12px rgba(0,0,0,.18));}
    .fall-coin{opacity:.28;filter:blur(.4px) drop-shadow(0 10px 12px rgba(0,0,0,.10));}
    @keyframes fallDown{
      0%{transform:translate3d(var(--x,0px), -80px, 0) rotate(0deg);}
      100%{transform:translate3d(calc(var(--x,0px) + var(--drift,120px)), calc(100vh + 120px), 0) rotate(var(--rot,540deg));}
    }

    button{
      position:relative;
      transition: transform .14s ease, box-shadow .14s ease, outline-color .14s ease, filter .14s ease;
      outline: 2px solid transparent;
      outline-offset: 3px;
    }
    button:hover{
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 14px 28px rgba(0,0,0,.28);
      outline-color: rgba(255,215,0,.55);
    }
    button.btn-active{
      transform: translateY(-2px) scale(1.08);
      outline-color: rgba(255,215,0,.95);
      box-shadow: 0 18px 40px rgba(0,0,0,.35), 0 0 0 6px rgba(255,215,0,.18);
      filter: saturate(1.05);
    }

    :root{
      --line:rgba(255,255,255,.18);
      --text:#fff3f7;
      --muted:#ffe0ec;
      --gold:#ffd700;
      --btn:#ffd700;
      --btn2:#5c0014;
      --radius:26px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Times New Roman", Times, serif;
      background: url("bg-2026.jpg") no-repeat center center fixed;
      background-size: 100%;
      background-position: center 30%;
      color:var(--text);
      min-height:100vh;
      padding:26px;
      position:relative;
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background: rgba(120,0,0,0.55);
      backdrop-filter: blur(2px);
      z-index:0;
    }

    .web-logo{
      position:fixed; top:18px; left:22px;
      font-size:38px; z-index:999;
      animation: floatLogo 3s ease-in-out infinite;
    }
    @keyframes floatLogo{0%{transform:translateY(0px);}50%{transform:translateY(-6px);}100%{transform:translateY(0px);}}

    .logo-watermark{position:absolute; top:10px; right:20px;font-size:60px;opacity:.08;pointer-events:none;}

    .container{
      width:min(1050px,100%);
      display:grid;
      grid-template-columns:1.15fr .85fr;
      gap:18px;
      position:relative;
      z-index:2;
      margin:0 auto;
    }
    @media (max-width:900px){ .container{grid-template-columns:1fr} }

    .card{
      background: linear-gradient(180deg, rgba(179,0,59,.92), rgba(139,0,0,.92));
      border:3px solid var(--gold);
      border-radius:var(--radius);
      padding:22px;
      box-shadow:0 18px 55px rgba(0,0,0,.45);
      position:relative;
      z-index:60;
    }

    h1{margin:0;font-size:42px;font-weight:900;color:var(--gold);text-align:center;letter-spacing:1px;}
    .sub{text-align:center;color:var(--muted);margin:10px 0 18px;font-size:18px;}

    label{display:block;margin-top:14px}
    label span{display:block;font-size:18px;margin-bottom:8px;color:var(--muted);font-weight:700;}

    input{
      width:100%;
      padding:14px 16px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.12);
      color:var(--text);
      outline:none;
      font-size:18px;
      font-family:"Times New Roman", Times, serif;
    }
    input::placeholder{color:#ffd1e3}

    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:18px;}
    button{border:0;border-radius:16px;padding:12px 18px;font-weight:900;cursor:pointer;font-size:18px;font-family:"Times New Roman", Times, serif;}
    .btn{background:var(--btn); color:#7a0000;}
    .btn.secondary{background:var(--btn2); color:var(--text); border:1px solid var(--line)}
    .btn.guest{background:rgba(255,255,255,.14); color:var(--text); border:1px solid var(--gold)}
    .btn.google{background:#fff; color:#7a0000;}

    .msg{margin-top:12px;font-size:16px;color:var(--muted);line-height:1.4;min-height:22px;}
    .danger{color:#ffd0d0}
    .hint{margin-top:10px;font-size:15px;color:var(--muted);}
    .title2{margin:0;color:var(--gold);font-size:28px;font-weight:900;}

    .login-link{margin-top:12px;text-align:center;}
    .login-link a{color:#0b1bff;font-weight:900;text-decoration:underline;cursor:pointer;}

    .profile{display:flex;gap:14px;align-items:center;padding:14px;border:2px solid var(--gold);border-radius:18px;margin-top:14px;background:rgba(255,255,255,.08);}
    .avatar{width:64px;height:64px;border-radius:50%;border:3px solid var(--gold);object-fit:cover;}
    .name{font-weight:900;color:var(--gold);font-size:22px}
    .email{font-size:16px;color:var(--muted)}
    .hidden{display:none !important}

    .wrap{
      position:relative;z-index:2;width:min(1100px,100%);
      margin:0 auto;display:grid;grid-template-columns:360px 1fr;gap:18px;
    }
    @media (max-width:900px){ .wrap{grid-template-columns:1fr} }
    h1,h2{margin:0;color:var(--gold);font-weight:900}
    h2{font-size:22px;margin-bottom:10px}
    .muted{color:var(--muted)}
    .spacer{height:12px}

    .avatarBox{display:flex;gap:14px;align-items:center;padding:14px;border:2px solid var(--gold);border-radius:18px;background:rgba(255,255,255,.08);}
    .avatarBig{width:86px;height:86px;border-radius:50%;border:3px solid var(--gold);object-fit:cover;background:rgba(255,255,255,.15);}
    .emailSmall{font-size:13px;color:var(--muted);opacity:.95;max-width:210px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    @media (max-width:900px){ .emailSmall{max-width:100%;} }

    textarea{
      width:100%;padding:12px 14px;border-radius:16px;border:1px solid var(--line);
      background:rgba(255,255,255,.12);color:var(--text);outline:none;font-size:18px;
      font-family:"Times New Roman", Times, serif;min-height:120px;resize:vertical;
    }

    .btnDash{
      border:0;border-radius:16px;padding:12px 16px;font-weight:900;cursor:pointer;
      font-size:18px;font-family:"Times New Roman", Times, serif;outline:2px solid transparent;outline-offset:3px;
      transition: transform .14s ease, box-shadow .14s ease, outline-color .14s ease;
    }
    .btnDash:hover{
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 14px 28px rgba(0,0,0,.28);
      outline-color: rgba(255,215,0,.55);
    }

    .stats{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:12px;margin-top:12px;}
    .stat{background:rgba(255,255,255,.09);border:1px solid rgba(255,215,0,.35);border-radius:18px;padding:12px;}
    .stat .k{color:var(--muted);font-weight:900}
    .stat .v{font-size:26px;font-weight:900;color:var(--gold);margin-top:4px}

    .notifItem{padding:12px;border-radius:16px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);margin-top:10px;}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      position:relative;z-index:2;width:min(1100px,100%);margin:0 auto 18px;
    }

    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);z-index:9999;padding:18px;}
    .modal.show{display:grid;}
    .modalCard{width:min(680px,100%);background:linear-gradient(180deg, rgba(179,0,59,.96), rgba(139,0,0,.96));border:3px solid var(--gold);border-radius:22px;padding:16px;box-shadow:0 18px 55px rgba(0,0,0,.55);}
    .modalTop{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:10px;}
    .cropWrap{display:grid;grid-template-columns:1fr 220px;gap:14px;align-items:start;}
    @media (max-width:800px){ .cropWrap{grid-template-columns:1fr;} }
    .cropStage{background:rgba(255,255,255,.06);border:1px solid rgba(255,215,0,.25);border-radius:18px;padding:12px;}
    .cropCanvas{width:100%;aspect-ratio:1/1;background:rgba(255,255,255,.06);border-radius:16px;border:1px dashed rgba(255,215,0,.35);display:block;touch-action:none;cursor:grab;}
    .sideBox{background:rgba(255,255,255,.06);border:1px solid rgba(255,215,0,.25);border-radius:18px;padding:12px;}
    .preview{width:140px;height:140px;border-radius:50%;border:3px solid var(--gold);object-fit:cover;background:rgba(255,255,255,.12);display:block;margin:0 auto 10px;}
    .range{width:100%}

    .view{display:none}
    .view.active{display:block}
  </style>
</head>

<body>
  <div class="web-logo">üå∏</div>

  <!-- REGISTER VIEW -->
  <section id="viewRegister" class="view active">
    <div class="container">
      <section class="card">
        <div class="logo-watermark">üå∏</div>

        <h1>üéä Trang ƒëƒÉng k√Ω - Xu√¢n 12A1 üéä</h1>
        <div class="sub">üå∏ T·∫øt B√≠nh Ng·ªç 2026 ‚Äì L·ªõp 12A1 üå∏</div>

        <label>
          <span>‚úâÔ∏è Email</span>
          <input id="email" type="email" placeholder="abc123@gmail.com" autocomplete="email">
        </label>

        <label>
          <span>üîë M·∫≠t kh·∫©u</span>
          <input id="password" type="password" placeholder="123456" autocomplete="new-password">
        </label>

        <label>
          <span>üôã‚Äç‚ôÇÔ∏è T√™n hi·ªÉn th·ªã</span>
          <input id="displayName" type="text" placeholder="VD: Nguy·ªÖn VƒÉn A" autocomplete="nickname">
        </label>

        <div class="row">
          <button id="btnRegister" class="btn secondary">ƒêƒÉng k√Ω</button>
          <button id="btnGuest" class="btn guest">Kh√°ch</button>
        </div>

        <div id="msg" class="msg"></div>
        <div class="hint">L∆∞u √Ω: Ch·∫ø ƒë·ªô <b>Kh√°ch</b> b·∫Øt bu·ªôc nh·∫≠p <b>"T√™n hi·ªÉn th·ªã"</b> m·ªõi ƒë∆∞·ª£c v√†o.</div>

        <p class="login-link">
          <a id="goLogin">ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p</a>
        </p>
      </section>

      <section class="card">
        <h2 class="title2">Th√¥ng tin website</h2>

        <div id="loggedOut" class="msg">
          N∆°i k·∫øt n·ªëi ‚Äì chia s·∫ª ‚Äì ƒë·ªìng h√†nh c√πng nhau trong m√πa xu√¢n v√† k·ª≥ thi ph√≠a tr∆∞·ªõc.
        </div>

        <div id="loggedIn" class="hidden">
          <div class="profile">
            <img id="avatar" class="avatar" alt="avatar">
            <div>
              <div id="name" class="name"></div>
              <div id="userEmail" class="email"></div>
            </div>
          </div>

          <div class="row">
            <button id="btnLogout" class="btn secondary" type="button">ƒêƒÉng xu·∫•t</button>
          </div>
        </div>
      </section>
    </div>
  </section>

  <!-- LOGIN VIEW -->
  <section id="viewLogin" class="view">
    <div class="container">
      <section class="card">
        <div class="logo-watermark">üå∏</div>

        <h1>üéä Trang ƒëƒÉng nh·∫≠p - Xu√¢n 12A1 üéä</h1>
        <div class="sub">üå∏ T·∫øt B√≠nh Ng·ªç 2026 ‚Äì L·ªõp 12A1 üå∏</div>

        <label>
          <span>‚úâÔ∏è Email</span>
          <input id="email2" type="email" placeholder="abc123@gmail.com" autocomplete="email">
        </label>

        <label>
          <span>üîë M·∫≠t kh·∫©u</span>
          <input id="password2" type="password" placeholder="123456" autocomplete="current-password">
        </label>

        <div class="row">
          <button id="btnLogin" class="btn" type="button">ƒêƒÉng nh·∫≠p</button>
          <button id="btnGoogle" class="btn google" type="button">Google</button>
        </div>

        <div id="msg2" class="msg"></div>
        <div class="hint">B·∫°n c√≥ th·ªÉ ƒëƒÉng nh·∫≠p b·∫±ng Email/M·∫≠t kh·∫©u ho·∫∑c Google.</div>

        <p class="login-link">
          <a id="goRegister">Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω</a>
        </p>
      </section>

      <section class="card">
        <h2 class="title2">Th√¥ng tin website</h2>

        <div id="loggedOut2" class="msg">
          N∆°i k·∫øt n·ªëi ‚Äì chia s·∫ª ‚Äì ƒë·ªìng h√†nh c√πng nhau trong m√πa xu√¢n v√† k·ª≥ thi ph√≠a tr∆∞·ªõc.
        </div>

        <div id="loggedIn2" class="hidden">
          <div class="profile">
            <img id="avatar2" class="avatar" alt="avatar">
            <div>
              <div id="name2" class="name"></div>
              <div id="userEmail2" class="email"></div>
            </div>
          </div>

          <div class="row">
            <button id="btnLogout2" class="btn secondary" type="button">ƒêƒÉng xu·∫•t</button>
          </div>
        </div>
      </section>
    </div>
  </section>

  <!-- DASHBOARD VIEW -->
  <section id="viewDashboard" class="view">
    <div class="topbar">
  <h1>üéä Th√¥ng tin ng∆∞·ªùi d√πng</h1>
  <div class="row">
    <!-- ‚úÖ ƒê·ªïi id ƒë·ªÉ kh√¥ng b·ªã JS c≈© auto chuy·ªÉn v·ªÅ web ch√≠nh -->
    <a id="btnHomeLocal" class="btnDash btn"
   href="https://xuanbinhngo-2026.web.app/#home"
   rel="noopener">
  Trang ch·ªß
</a>
    <button id="btnLogoutDash" class="btnDash btn secondary" type="button">ƒêƒÉng xu·∫•t</button>
  </div>
</div>

    <div class="wrap">
      <section class="card">
        <h2>Th√¥ng tin ng∆∞·ªùi d√πng</h2>

        <div class="avatarBox">
          <img id="avatarDash" class="avatarBig" alt="avatar">
          <div>
            <div id="nameDash" style="font-size:22px; font-weight:900; color:var(--gold);">‚Äî</div>
            <div id="emailDash" class="emailSmall">‚Äî</div>
          </div>
        </div>

        <label>
          <span>ƒê·ªïi t√™n hi·ªÉn th·ªã</span>
          <input id="displayNameDash" placeholder="VD: Tr·∫ßn VƒÉn B">
        </label>

        <label>
          <span>ƒê·ªïi avatar (ch·ªçn ·∫£nh)</span>
          <input id="avatarFile" type="file" accept="image/*">
        </label>

        <div class="row" style="margin-top:12px;">
          <button id="btnSaveProfile" class="btnDash btn" type="button">L∆∞u h·ªì s∆°</button>
          <button id="btnResetAvatar" class="btnDash btn secondary" type="button">Avatar m·∫∑c ƒë·ªãnh</button>
        </div>

        <div id="msgDash" class="muted" style="margin-top:12px; min-height:22px;"></div>
      </section>

      <section class="card">
        <h2>Tr·∫°ng th√°i & Th√†nh t√≠ch</h2>

        <div class="stats">
          <div class="stat">
            <div class="k">S·ªë ü™ô</div>
            <div id="coins" class="v">0</div>
            <div class="muted" style="margin-top:6px;font-size:14px;">(C·∫≠p nh·∫≠t t·ª± ƒë·ªông)</div>
          </div>

          <div class="stat">
            <div class="k">L∆∞·ª£t t∆∞∆°ng t√°c</div>
            <div id="interactions" class="v">0</div>
            <div class="muted" style="margin-top:6px;font-size:14px;">(C·∫≠p nh·∫≠t t·ª± ƒë·ªông)</div>
          </div>
        </div>

        <div class="spacer"></div>

        <label>
          <span>Th√†nh t√≠ch</span>
          <textarea id="achievement" placeholder="(S·∫Ω hi·ªÉn th·ªã th√†nh t√≠ch c√° nh√¢n)" readonly></textarea>
        </label>

        <div class="spacer"></div>

        <h2>Th√¥ng b√°o</h2>
        <div id="notifList"></div>

        <label>
          <span>Th√™m th√¥ng b√°o m·ªõi</span>
          <input id="notifText" placeholder="VD: 20h t·ªëi nay ch∆°i l√¥ t√¥ ph√≤ng 12A1!">
        </label>
        <div class="row" style="margin-top:12px;">
          <button id="btnAddNotif" class="btnDash btn" type="button">ƒêƒÉng th√¥ng b√°o</button>
          <button id="btnClearNotif" class="btnDash btn secondary" type="button">X√≥a h·∫øt</button>
        </div>
      </section>
    </div>

    <!-- MODAL CROP (gi·ªØ nguy√™n HTML) -->
    <div id="cropModal" class="modal" aria-hidden="true">
      <div class="modalCard">
        <div class="modalTop">
          <h2 style="margin:0;">C·∫Øt ·∫£nh Avatar</h2>
          <button id="btnCropClose" class="btnDash btn secondary" type="button">ƒê√≥ng</button>
        </div>

        <div class="cropWrap">
          <div class="cropStage">
            <div class="muted" style="margin-bottom:10px;">
              K√©o ·∫£nh ƒë·ªÉ canh m·∫∑t. D√πng thanh Zoom ƒë·ªÉ ph√≥ng/thu.
            </div>
            <canvas id="cropCanvas" class="cropCanvas" width="600" height="600"></canvas>
          </div>

          <div class="sideBox">
            <img id="cropPreview" class="preview" alt="preview">
            <label style="margin:0;">
              <span>Zoom</span>
              <input id="zoomRange" class="range" type="range" min="1" max="3" step="0.01" value="1.2">
            </label>

            <div class="row" style="margin-top:12px;">
              <button id="btnCropApply" class="btnDash btn" type="button">D√πng ·∫£nh n√†y</button>
              <button id="btnCropReset" class="btnDash btn secondary" type="button">Reset</button>
            </div>

            <div class="muted" style="margin-top:10px;font-size:14px;">
              ·∫¢nh s·∫Ω ƒë∆∞·ª£c c·∫Øt h√¨nh vu√¥ng v√† hi·ªÉn th·ªã tr√≤n khi l∆∞u.
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ‚úÖ FX ch·ªâ 1 l·∫ßn -->
  <script>
    // fx.js inline (y nh∆∞ b·∫°n)
    function createEl(tag, className) { const el = document.createElement(tag); if (className) el.className = className; return el; }
    function rand(min, max) { return Math.random() * (max - min) + min; }

    function setupBranches() {
      const left = createEl("div", "fx-branch left");
      const right = createEl("div", "fx-branch right");
      const bloomsL = createEl("div", "fx-blossoms");
      const bloomsR = createEl("div", "fx-blossoms");
      const blossomCount = 14;

      for (let i = 0; i < blossomCount; i++) {
        const b1 = createEl("span");
        b1.textContent = "üåº";
        b1.style.left = `${rand(40, 200)}px`;
        b1.style.top = `${rand(40, 560)}px`;
        b1.style.transform = `rotate(${rand(-30, 30)}deg)`;
        b1.style.opacity = `${rand(0.65, 0.95)}`;
        bloomsL.appendChild(b1);

        const b2 = createEl("span");
        b2.textContent = "üåº";
        b2.style.left = `${rand(40, 200)}px`;
        b2.style.top = `${rand(40, 560)}px`;
        b2.style.transform = `rotate(${rand(-30, 30)}deg)`;
        b2.style.opacity = `${rand(0.65, 0.95)}`;
        bloomsR.appendChild(b2);
      }

      left.appendChild(bloomsL);
      right.appendChild(bloomsR);
      document.body.appendChild(left);
      document.body.appendChild(right);
    }

    function setupFallingFX() {
      const layer = createEl("div", "fx-layer");
      layer.id = "fx-layer";
      document.body.appendChild(layer);

      const makeItem = (type) => {
        const s = createEl("span", `fall-item ${type === "flower" ? "fall-flower" : "fall-coin"}`);
        s.textContent = type === "flower" ? "üå∏" : "ü™ô";

        const size = type === "flower" ? rand(14, 24) : rand(16, 30);
        s.style.fontSize = `${size}px`;

        const left = rand(0, window.innerWidth);
        s.style.left = `${left}px`;

        const duration = type === "flower" ? rand(7.5, 13) : rand(9, 16);
        s.style.animationDuration = `${duration}s`;

        const delay = rand(0, 6);
        s.style.animationDelay = `${delay}s`;

        s.style.setProperty("--x", `${rand(-60, 60)}px`);
        s.style.setProperty("--drift", `${rand(-160, 160)}px`);
        s.style.setProperty("--rot", `${rand(240, 900)}deg`);

        layer.appendChild(s);
      };

      for (let i = 0; i < 26; i++) makeItem("flower");
      for (let i = 0; i < 10; i++) makeItem("coin");
    }

    function setupButtonFX() {
      const ids = ["btnLogin", "btnRegister", "btnGoogle", "btnGuest", "btnLogout", "btnLogout2", "btnLogoutDash"];
      ids.forEach((id) => {
        const btn = document.getElementById(id);
        if (!btn) return;
        btn.addEventListener("click", () => {
          btn.classList.add("btn-active");
          setTimeout(() => btn.classList.remove("btn-active"), 260);
        });
      });
    }

    setupBranches();
    setupFallingFX();
    setupButtonFX();
  </script>

  <!-- ‚úÖ SWITCH VIEW (1 n∆°i duy nh·∫•t) -->
  <script>
    const viewRegister = document.getElementById("viewRegister");
    const viewLogin = document.getElementById("viewLogin");
    const viewDashboard = document.getElementById("viewDashboard");

    const goLogin = document.getElementById("goLogin");
    const goRegister = document.getElementById("goRegister");

    function showView(which){
      [viewRegister, viewLogin, viewDashboard].forEach(v => v.classList.remove("active"));
      if(which === "register") viewRegister.classList.add("active");
      if(which === "login") viewLogin.classList.add("active");
      if(which === "dashboard") viewDashboard.classList.add("active");
      window.scrollTo({top:0, behavior:"smooth"});
    }

    goLogin?.addEventListener("click", ()=> showView("login"));
    goRegister?.addEventListener("click", ()=> showView("register"));
    document.getElementById("btnHome")?.addEventListener("click", ()=> showView("register"));
  </script>

  <!-- ‚úÖ ALL-IN-ONE FIREBASE JS (1 l·∫ßn duy nh·∫•t) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signInWithPopup,
      GoogleAuthProvider,
      signInAnonymously,
      updateProfile,
      signOut
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      serverTimestamp,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDfZPIg6Nif_Mx_Wwyl0byM6vJCd5BLgo8",
      authDomain: "xuanbinhngo-2026.firebaseapp.com",
      projectId: "xuanbinhngo-2026",
      storageBucket: "xuanbinhngo-2026.appspot.com",
      messagingSenderId: "910448630867",
      appId: "1:910448630867:web:2b48e0b859e355aa0efaa6",
      measurementId: "G-FN0BFL9FQQ"
    };

    const DEFAULT_AVATAR = "https://api.dicebear.com/7.x/thumbs/svg?seed=Xuan12A1";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== Helpers =====
    function setText(id, text){
      const el = document.getElementById(id);
      if(el) el.textContent = text ?? "";
    }
    function showMsg(id, text, isErr=false){
      const el = document.getElementById(id);
      if(!el) return;
      el.textContent = text || "";
      el.classList.toggle("danger", !!isErr);
    }

    async function ensureUserDoc(user) {
      const refUser = doc(db, "users", user.uid);
      const snap = await getDoc(refUser);
      if (!snap.exists()) {
        await setDoc(refUser, {
          uid: user.uid,
          displayName: user.displayName || "User",
          avatarBase64: "",
          photoURL: user.photoURL || DEFAULT_AVATAR,
          coins: 0,
          interactions: 0,
          achievement: "",
          notifications: [],
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
      }
      return refUser;
    }

    function renderNotifs(items = []) {
      const notifList = document.getElementById("notifList");
      if (!notifList) return;
      notifList.innerHTML = "";
      if (!items.length) {
        notifList.innerHTML = `<div class="muted">Ch∆∞a c√≥ th√¥ng b√°o n√†o.</div>`;
        return;
      }
      items.slice(0, 10).forEach((n) => {
        const div = document.createElement("div");
        div.className = "notifItem";
        div.innerHTML = `
          <div style="font-weight:900;color:var(--gold)">${n.title || "üì¢ Th√¥ng b√°o"}</div>
          <div class="muted" style="margin-top:6px">${n.text || ""}</div>
        `;
        notifList.appendChild(div);
      });
    }

    // ===== Register =====
    document.getElementById("btnRegister")?.addEventListener("click", async () => {
      try{
        showMsg("msg", "");
        const email = document.getElementById("email")?.value?.trim();
        const pass = document.getElementById("password")?.value?.trim();
        const name = document.getElementById("displayName")?.value?.trim();

        if(!email || !pass) return showMsg("msg", "Vui l√≤ng nh·∫≠p email v√† m·∫≠t kh·∫©u.", true);
        if(pass.length < 6) return showMsg("msg", "M·∫≠t kh·∫©u t·ªëi thi·ªÉu 6 k√Ω t·ª±.", true);

        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await updateProfile(cred.user, { displayName: name || "User", photoURL: DEFAULT_AVATAR });
        showMsg("msg", "ƒêƒÉng k√Ω th√†nh c√¥ng! ƒêang v√†o Dashboard...");
      }catch(e){
        showMsg("msg", e?.message || "L·ªói ƒëƒÉng k√Ω", true);
      }
    });

    document.getElementById("btnGuest")?.addEventListener("click", async () => {
      try{
        showMsg("msg", "");
        const name = document.getElementById("displayName")?.value?.trim();
        if(!name) return showMsg("msg", "B·∫°n ph·∫£i nh·∫≠p T√™n hi·ªÉn th·ªã ƒë·ªÉ v√†o v·ªõi t∆∞ c√°ch Kh√°ch.", true);

        const cred = await signInAnonymously(auth);
        await updateProfile(cred.user, { displayName: `${name} (Kh√°ch)`, photoURL: DEFAULT_AVATAR });
        showMsg("msg", "ƒê√£ v√†o v·ªõi t∆∞ c√°ch Kh√°ch! ƒêang v√†o Dashboard...");
      }catch(e){
        showMsg("msg", e?.message || "L·ªói v√†o kh√°ch", true);
      }
    });

    // ===== Login =====
    document.getElementById("btnLogin")?.addEventListener("click", async () => {
      try{
        showMsg("msg2", "");
        const email = document.getElementById("email2")?.value?.trim();
        const pass = document.getElementById("password2")?.value?.trim();
        if(!email || !pass) return showMsg("msg2", "Vui l√≤ng nh·∫≠p email v√† m·∫≠t kh·∫©u.", true);

        await signInWithEmailAndPassword(auth, email, pass);
        showMsg("msg2", "ƒêƒÉng nh·∫≠p th√†nh c√¥ng! ƒêang v√†o Dashboard...");
      }catch(e){
        showMsg("msg2", e?.message || "L·ªói ƒëƒÉng nh·∫≠p", true);
      }
    });

    document.getElementById("btnGoogle")?.addEventListener("click", async () => {
      try{
        showMsg("msg2", "");
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
        showMsg("msg2", "ƒêƒÉng nh·∫≠p Google th√†nh c√¥ng! ƒêang v√†o Dashboard...");
      }catch(e){
        showMsg("msg2", e?.message || "L·ªói Google", true);
      }
    });

    // ===== Logout buttons =====
    document.getElementById("btnLogout")?.addEventListener("click", async ()=> { await signOut(auth); });
    document.getElementById("btnLogout2")?.addEventListener("click", async ()=> { await signOut(auth); });
    document.getElementById("btnLogoutDash")?.addEventListener("click", async ()=> { await signOut(auth); });

    // ===== Dashboard actions =====
    let unsub = null;
    let croppedBase64 = null;

    document.getElementById("avatarFile")?.addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if(!file) return;
      if(!file.type.startsWith("image/")) return showMsg("msgDash", "File kh√¥ng ph·∫£i h√¨nh ·∫£nh.", true);
      if(file.size > 3 * 1024 * 1024) return showMsg("msgDash", "·∫¢nh qu√° l·ªõn (t·ªëi ƒëa ~3MB).", true);

      const reader = new FileReader();
      reader.onload = () => {
        croppedBase64 = reader.result;
        const img = document.getElementById("avatarDash");
        if(img) img.src = croppedBase64;
        showMsg("msgDash", "ƒê√£ ch·ªçn avatar m·ªõi (ch∆∞a l∆∞u). B·∫•m 'L∆∞u h·ªì s∆°' ƒë·ªÉ c·∫≠p nh·∫≠t.");
      };
      reader.readAsDataURL(file);
    });

    document.getElementById("btnSaveProfile")?.addEventListener("click", async () => {
      try{
        showMsg("msgDash", "");
        const u = auth.currentUser;
        if(!u) return;

        const newName = (document.getElementById("displayNameDash")?.value || "").trim() || "User";
        const refUser = doc(db, "users", u.uid);

        await updateProfile(u, { displayName: newName }); // ‚úÖ kh√¥ng nh√©t base64 v√†o photoURL

        await updateDoc(refUser, {
          displayName: newName,
          avatarBase64: croppedBase64 || "",
          photoURL: croppedBase64 ? "" : (u.photoURL || DEFAULT_AVATAR),
          updatedAt: serverTimestamp()
        });

        showMsg("msgDash", "ƒê√£ l∆∞u h·ªì s∆°!");
        croppedBase64 = null;
        const f = document.getElementById("avatarFile");
        if(f) f.value = "";
      }catch(e){
        showMsg("msgDash", e?.message || "L·ªói l∆∞u h·ªì s∆°", true);
      }
    });

    document.getElementById("btnResetAvatar")?.addEventListener("click", async () => {
      try{
        const u = auth.currentUser;
        if(!u) return;
        const refUser = doc(db, "users", u.uid);
        await updateDoc(refUser, { avatarBase64:"", photoURL: DEFAULT_AVATAR, updatedAt: serverTimestamp() });
        const img = document.getElementById("avatarDash");
        if(img) img.src = DEFAULT_AVATAR;
        showMsg("msgDash", "ƒê√£ ƒë·∫∑t avatar m·∫∑c ƒë·ªãnh.");
      }catch(e){
        showMsg("msgDash", e?.message || "L·ªói reset avatar", true);
      }
    });

    document.getElementById("btnAddNotif")?.addEventListener("click", async () => {
      try{
        showMsg("msgDash", "");
        const u = auth.currentUser;
        if(!u) return;

        const text = (document.getElementById("notifText")?.value || "").trim();
        if(!text) return showMsg("msgDash", "Nh·∫≠p n·ªôi dung th√¥ng b√°o tr∆∞·ªõc nh√©.", true);

        const refUser = doc(db, "users", u.uid);
        const snap = await getDoc(refUser);
        const data = snap.data() || {};
        const arr = Array.isArray(data.notifications) ? data.notifications : [];
        const next = [{ title:"üì¢ Th√¥ng b√°o", text, ts: Date.now() }, ...arr].slice(0, 15);

        await updateDoc(refUser, { notifications: next, updatedAt: serverTimestamp() });
        document.getElementById("notifText").value = "";
        showMsg("msgDash", "ƒê√£ ƒëƒÉng th√¥ng b√°o!");
      }catch(e){
        showMsg("msgDash", e?.message || "L·ªói th√¥ng b√°o", true);
      }
    });

    document.getElementById("btnClearNotif")?.addEventListener("click", async () => {
      const u = auth.currentUser;
      if(!u) return;
      const refUser = doc(db, "users", u.uid);
      await updateDoc(refUser, { notifications: [], updatedAt: serverTimestamp() });
      showMsg("msgDash", "ƒê√£ x√≥a t·∫•t c·∫£ th√¥ng b√°o.");
    });

    // ===== Core: Auth state -> chuy·ªÉn dashboard ngay =====
    onAuthStateChanged(auth, async (user) => {
      if (unsub) { unsub(); unsub = null; }

      if (!user) {
        // ch∆∞a login => v·ªÅ login (ho·∫∑c register t√πy b·∫°n)
        showView("login");
        return;
      }

      // ƒë√£ login => dashboard
      showView("dashboard");

      // update mini status ·ªü Register/Login (n·∫øu b·∫°n mu·ªën)
      const avt = user.photoURL || DEFAULT_AVATAR;
      const nm = user.displayName || "User";
      const em = user.email || (user.isAnonymous ? "T√†i kho·∫£n Kh√°ch" : "‚Äî");

      // Register status
      const a1 = document.getElementById("avatar"); if(a1) a1.src = avt;
      setText("name", nm);
      setText("userEmail", em);

      // Login status
      const a2 = document.getElementById("avatar2"); if(a2) a2.src = avt;
      setText("name2", nm);
      setText("userEmail2", em);

      // Dashboard header
      const aD = document.getElementById("avatarDash"); if(aD) aD.src = avt;
      setText("nameDash", nm);
      setText("emailDash", em);
      const inp = document.getElementById("displayNameDash"); if(inp) inp.value = nm;

      const refUser = await ensureUserDoc(user);

      unsub = onSnapshot(refUser, (snap) => {
        const data = snap.data() || {};
        const avatarFinal = data.avatarBase64 || data.photoURL || user.photoURL || DEFAULT_AVATAR;

        const img = document.getElementById("avatarDash");
        if(img) img.src = avatarFinal;

        setText("nameDash", data.displayName || nm);
        setText("coins", data.coins ?? 0);
        setText("interactions", data.interactions ?? 0);

        const ach = document.getElementById("achievement");
        if(ach) ach.value = data.achievement ?? "";

        renderNotifs(data.notifications || []);
      });
    });
  </script>
</body>
</html>






